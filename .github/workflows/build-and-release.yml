name: Build and Release

on:
  push:
    tags:
      - 'v*'  # e.g., v1.2.3
  workflow_dispatch: { }

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  FLUTTER_VERSION: '3.35.2'

jobs:
  verify:
    name: Verify (lint, test, scan)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 20
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print runner info (debug)
        id: print_runner_info
        shell: bash
        run: |
          echo "OS: $(uname -a)"
          echo "Repo: $GITHUB_REPOSITORY"
          echo "Ref: $GITHUB_REF"
          echo "Actor: $GITHUB_ACTOR"
          echo "Workspace: $GITHUB_WORKSPACE"
          ls -la

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Cache Pub
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart-tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Flutter doctor
        id: flutter_doctor
        shell: bash
        run: |
          flutter --version
          flutter doctor -v

      - name: Flutter Pub Get
        shell: bash
        run: flutter pub get

      - name: Check formatting
        shell: bash
        run: dart format --output=none --set-exit-if-changed .
        continue-on-error: true

      - name: Analyze code
        shell: bash
        run: flutter analyze
        continue-on-error: true

      - name: Run tests
        shell: bash
        run: flutter test --coverage
        continue-on-error: true

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Scan dependencies (OSV-Scanner)
        shell: bash
        run: |
          go install github.com/google/osv-scanner/v2/cmd/osv-scanner@latest
          "$HOME/go/bin/osv-scanner" scan --lockfile=pubspec.lock
        continue-on-error: true

  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: verify
    permissions:
      contents: read
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]
    steps:
      - name: Resolve APP_NAME
        id: app_name
        shell: bash
        run: |
          # Prefer pubspec.yaml app_name, else fallback to repo name, else env
          NAME_FROM_PUBSPEC=""
          if [ -f pubspec.yaml ]; then
            NAME_FROM_PUBSPEC="$(grep -E '^[[:space:]]app_name:[[:space:]]*' pubspec.yaml \
              | head -n1 \
              | sed -E 's/^[[:space:]]*app_name:[[:space:]]*\"?([^"]*)\"?/\1/' \
              || true)"
          fi
          if [ -n "${NAME_FROM_PUBSPEC}" ]; then
            APP_NAME_RESOLVED="${NAME_FROM_PUBSPEC}"
          elif [ -n "${APP_NAME:-}" ]; then
            APP_NAME_RESOLVED="${APP_NAME}"
          else
            APP_NAME_RESOLVED="${GITHUB_REPOSITORY##*/}"
          fi
          echo "APP_NAME=${APP_NAME_RESOLVED}" | tee -a "$GITHUB_ENV"
          echo "resolved=${APP_NAME_RESOLVED}" >> "$GITHUB_OUTPUT"

      - name: Slugify APP_NAME
        id: slugify_app
        if: matrix.os == 'Linux' || matrix.os == 'macOS'
        shell: bash
        run: |
          APP_NAME="${{ steps.app_name.outputs.resolved }}"
          SLUG=$(echo "$APP_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-')
          echo "SLUG_APP_NAME=$SLUG" | tee -a "$GITHUB_ENV"
          echo "slug=$SLUG" >> "$GITHUB_OUTPUT"

      - name: Slugify APP_NAME (Windows)
        if: runner.os == 'Windows'
        id: slugify_app
        shell: pwsh
        run: |
          $APP_NAME = "${{ steps.app_name.outputs.resolved }}"
          $SLUG = $APP_NAME.ToLower() -replace ' ', '-' -replace '[^a-z0-9\-]', ''
          Write-Output "SLUG_APP_NAME=$SLUG" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Output "slug=$SLUG" >> $env:GITHUB_OUTPUT

      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Cache Pub
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart-tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Flutter doctor
        run: |
          flutter --version
          flutter doctor -v

      # Android build prerequisites and Java on non-macOS
      - name: Set up Java 17
        if: runner.os == 'Linux'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Ensure Android cmdline-tools + sdkmanager in PATH
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euxo pipefail
          echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-/usr/local/lib/android/sdk}"
          export ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-/usr/local/lib/android/sdk}"
          
          # Make sure cmdline-tools exist (runner images usually have them, but be explicit)
          if [ ! -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            echo "cmdline-tools not found, installing via sdkmanager bootstrap..."
            # Install base tools if missing
            mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
            # The runner typically has 'latest'; if not, fallback to preinstalled path hints
            ls -la "$ANDROID_SDK_ROOT" || true
          fi
          
          # Export PATH now and persist for subsequent steps
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> "$GITHUB_PATH"
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"
          which sdkmanager || true
          sdkmanager --version || true
          ls -la "$ANDROID_SDK_ROOT/cmdline-tools" || true
          ls -la "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" || true

      - name: Accept Android licenses + install packages (robust)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          export ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-/usr/local/lib/android/sdk}"
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"
          SDKMGR="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          if [ ! -x "$SDKMGR" ]; then
            echo "sdkmanager not found at $SDKMGR"
            find "$ANDROID_SDK_ROOT" -maxdepth 4 -type d -print
            exit 1
          fi
          echo "sdkmanager version: $("$SDKMGR" --version)"
          echo "Accepting licenses (ignore SIGPIPE from 'yes')..."
          set +o pipefail
          yes | "$SDKMGR" --licenses || true
          set -o pipefail
          echo "Installing required packages..."
          set +o pipefail
          yes | "$SDKMGR" --install \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "cmdline-tools;latest" || true
          set -o pipefail
          echo "Verifying installation..."
          test -d "$ANDROID_SDK_ROOT/platform-tools" || { echo "platform-tools missing"; exit 1; }
          test -d "$ANDROID_SDK_ROOT/build-tools/34.0.0" || { echo "build-tools 34.0.0 missing"; exit 1; }
          test -d "$ANDROID_SDK_ROOT/platforms/android-34" || { echo "platforms;android-34 missing"; exit 1; }
          echo "Installed packages (first 120 lines):"
          "$SDKMGR" --list | sed -n '1,120p' || true

      # Linux desktop deps
      - name: Install Linux desktop deps
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev mesa-utils

      - name: Toolchain info (debug)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          java -version
          flutter --version
          adb version || true
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          echo "PATH=$PATH"

      # Build Android (Ubuntu only to avoid duplication)
      - name: Build Android APK
        if: runner.os == 'Linux'
        shell: bash
        run: flutter build apk --release

      - name: Build Android App Bundle
        if: runner.os == 'Linux'
        shell: bash
        run: flutter build appbundle --release

      # Build Linux
      - name: Build Linux
        if: runner.os == 'Linux'
        shell: bash
        run: |
          flutter build linux --release
          mkdir -p "build/linux"
          SLUG="${{ steps.slugify_app.outputs.slug }}"
          zip -r "build/linux/$SLUG.zip" build/linux/x64/release/bundle/*

      ##### Build Windows #####
      - name: Build Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:APP_NAME="${{ steps.app_name.outputs.resolved }}"
          flutter build windows --release
          New-Item -ItemType Directory -Force -Path "build/windows" | Out-Null
          $src = "build/windows/x64/runner/Release/*"
          $SLUG = "${{ steps.slugify_app.outputs.slug }}"
          $dst = "build/windows/$SLUG.zip"
          Compress-Archive -Path $src -DestinationPath $dst

      ##### Build iOS (no codesign) + macOS #####
      - name: Build iOS (no codesign)
        if: runner.os == 'macOS'
        shell: bash
        run: flutter build ipa --release --no-codesign

      - name: Build macOS
        if: runner.os == 'macOS'
        shell: bash
        run: |
          flutter build macos --release
          mkdir -p "build/macos"
          app_path="$(ls -d build/macos/Build/Products/Release/*.app | head -n 1)"
          SLUG="${{ steps.slugify_app.outputs.slug }}"
          zip -r "build/macos/$SLUG.zip" "$app_path"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-artifacts
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/release/*.aab
            build/ios/ipa/*.ipa
            build/macos/*.zip
            build/windows/*.zip
            build/linux/*.zip
          compression-level: 9
          if-no-files-found: warn
          retention-days: 14

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve APP_NAME
        id: app_name
        shell: bash
        run: |
          # Prefer pubspec.yaml app_name, else fallback to repo name, else env
          NAME_FROM_PUBSPEC=""
          if [ -f pubspec.yaml ]; then
            NAME_FROM_PUBSPEC="$(grep -E '^[[:space:]]app_name:[[:space:]]*' pubspec.yaml \
              | head -n1 \
              | sed -E 's/^[[:space:]]*app_name:[[:space:]]*\"?([^"]*)\"?/\1/' \
              || true)"
          fi
          if [ -n "${NAME_FROM_PUBSPEC}" ]; then
            APP_NAME_RESOLVED="${NAME_FROM_PUBSPEC}"
          elif [ -n "${APP_NAME:-}" ]; then
            APP_NAME_RESOLVED="${APP_NAME}"
          else
            APP_NAME_RESOLVED="${GITHUB_REPOSITORY##*/}"
          fi
          echo "APP_NAME=${APP_NAME_RESOLVED}" | tee -a "$GITHUB_ENV"
          echo "resolved=${APP_NAME_RESOLVED}" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts (merge into ./artifacts)
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Show downloaded files (debug)
        id: show_artifacts
        shell: bash
        run: |
          echo "Artifacts directory content:"
          ls -la ./artifacts || true
          echo "--- Find (depth 5) ---"
          find ./artifacts -maxdepth 5 -type f -print | sort || true
          echo "--- Disk usage ---"
          du -sh ./artifacts || true

      - name: Extract version from tag
        id: app_version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "APP_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "clean=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Format commit date (UTC)
        id: format_date
        shell: bash
        run: echo "formatted_date=$(date -u +'%Y-%m-%d %H:%M UTC')" >> "$GITHUB_OUTPUT"

      - name: Prepare distribution folder and rename assets
        id: rename_assets
        shell: bash
        run: |
          set -euo pipefail
          APP_NAME="${{ steps.app_name.outputs.resolved }}"
          VER="${{ steps.app_version.outputs.clean }}"
          
          # Slugify app name for filenames
          SLUG="$(echo "$APP_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-')"
          mkdir -p dist
          shopt -s nullglob
          echo "Renaming assets with slug='${SLUG}' and version='${VER}'"
          echo "Artifacts tree:"
          find artifacts -type f | sort || true
          
          # Android APK(s)
          for f in artifacts/build/app/outputs/flutter-apk/*.apk; do
            [ -e "$f" ] || continue
            base="$(basename "$f")"
            cp -v "$f" "dist/${SLUG}-v${VER}-android-${base}"
          done
          
          # Android AAB(s)
          for f in artifacts/build/app/outputs/bundle/release/*.aab; do
            [ -e "$f" ] || continue
            base="$(basename "$f")"
            cp -v "$f" "dist/${SLUG}-v${VER}-android-${base}"
          done
          
          # iOS IPA(s)
          for f in artifacts/build/ios/ipa/*.ipa; do
            [ -e "$f" ] || continue
            base="$(basename "$f")"
            cp -v "$f" "dist/${SLUG}-v${VER}-ios-${base}"
          done
          
          # Windows ZIP(s)
          for f in artifacts/build/windows/*.zip; do
            [ -e "$f" ] || continue
            base="$(basename "$f")"
            cp -v "$f" "dist/${SLUG}-v${VER}-windows-${base}"
          done
          
          # Linux ZIP(s)
          for f in artifacts/build/linux/*.zip; do
            [ -e "$f" ] || continue
            base="$(basename "$f")"
            cp -v "$f" "dist/${SLUG}-v${VER}-linux-${base}"
          done
          
          # macOS ZIP(s)
          for f in artifacts/build/macos/*.zip; do
            [ -e "$f" ] || continue
            base="$(basename "$f")"
            cp -v "$f" "dist/${SLUG}-v${VER}-macos-${base}"
          done
          
          echo "Final dist content:"
          ls -la dist || true
          echo "---"
          find dist -maxdepth 1 -type f -print | sort || true
          # Optional: uncomment to fail if no files prepared
          # test -n "$(ls -A dist 2>/dev/null)" || { echo "No assets found in dist"; exit 1; }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "${{ env.APP_NAME }} ${{ env.APP_VERSION }}"
          body: |
            ## ğŸš€ Release ${{ env.APP_NAME }} ${{ env.APP_VERSION }}
            **ğŸ”– Version:** `${{ env.APP_VERSION }}`
            **ğŸ”— Commit:** `${{ github.sha }}`
            **ğŸ“… Date:** ${{ steps.format_date.outputs.formatted_date }}
            
            **ğŸƒâ€â™‚ï¸ Workflow Run:** [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            **ğŸ“‹ Changelog:** [changelog](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md)
            
            ### ğŸ“¦ Included Artifacts
            Android (APK/AAB), iOS (IPA), Windows (ZIP), macOS (ZIP), Linux (ZIP).
            
            ---
            _Generated automatically by CI/CD pipeline._
          files: ./dist/**
          draft: false
          prerelease: false

      - name: Summary (debug)
        id: summary
        shell: bash
        run: |
          echo "Release created for tag: ${{ github.ref_name }}"
          echo "Name: ${{ steps.app_name.outputs.resolved }} v${{ steps.app_version.outputs.clean }}"
          echo "Assets uploaded:"
          ls -la dist || true
