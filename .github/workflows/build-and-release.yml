name: Build and Release

on:
  push:
    tags:
      - 'v*'  # e.g., v1.2.3

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  APP_NAME: Beauty Center

jobs:
  verify:
    name: Verify (lint, test, scan)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 20
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.2'
          cache: true

      - name: Cache Pub
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart-tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Flutter doctor
        run: |
          flutter --version
          flutter doctor -v

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Check formatting
        run: dart format --output=none --set-exit-if-changed .
        continue-on-error: true

      - name: Analyze code
        run: flutter analyze
        continue-on-error: true

      - name: Run tests
        run: flutter test --coverage
        continue-on-error: true

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Scan dependencies (OSV-Scanner)
        run: |
          go install github.com/google/osv-scanner/v2/cmd/osv-scanner@latest
          "$HOME/go/bin/osv-scanner" scan --lockfile=pubspec.lock
        continue-on-error: true

  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: verify
    permissions:
      contents: read
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.2'
          cache: true

      - name: Cache Pub
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart-tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Flutter doctor
        run: |
          flutter --version
          flutter doctor -v

      # Android build prerequisites and Java on non-macOS
      - name: Set up Java 17
        if: runner.os != 'macOS'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Accept Android licenses (Ubuntu only)
        if: runner.os == 'Linux'
        shell: bash
        run: yes | sdkmanager --licenses || true

      # Linux desktop deps
      - name: Install Linux desktop deps
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      # Build Android (Ubuntu only to avoid duplication)
      - name: Build Android APK
        if: runner.os == 'Linux'
        run: flutter build apk --release

      - name: Build Android App Bundle
        if: runner.os == 'Linux'
        run: flutter build appbundle --release

      # Build Windows
      - name: Build Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          flutter build windows --release
          New-Item -ItemType Directory -Force -Path "build/windows" | Out-Null
          Compress-Archive -Path "build/windows/runner/Release/*" -DestinationPath "build/windows/${env:APP_NAME}.zip"

      # Build Linux
      - name: Build Linux
        if: runner.os == 'Linux'
        shell: bash
        run: |
          flutter build linux --release
          mkdir -p "build/linux"
          zip -r "build/linux/$APP_NAME.zip" build/linux/x64/release/bundle/*

      # Build iOS (no codesign) + macOS (only on macOS)
      - name: Build iOS (no codesign)
        if: runner.os == 'macOS'
        run: flutter build ipa --release --no-codesign

      - name: Build macOS
        if: runner.os == 'macOS'
        shell: bash
        run: |
          flutter build macos --release
          mkdir -p "build/macos"
          app_path="$(ls -d build/macos/Build/Products/Release/*.app | head -n 1)"
          zip -r "build/macos/$APP_NAME.zip" "$app_path"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-artifacts
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/release/*.aab
            build/ios/ipa/*.ipa
            build/macos/*.zip
            build/windows/*.zip
            build/linux/*.zip
          compression-level: 9
          if-no-files-found: warn
          retention-days: 14

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Extract version from tag
        run: echo "APP_VERSION=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"

      - name: Rename assets with version
        shell: bash
        run: |
          set -euo pipefail
          ver="${APP_VERSION#v}"
          # slugify APP_NAME to be filename-friendly
          slug="$(echo "$APP_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-')"
          mkdir -p dist
          shopt -s nullglob
          
          # Android APK(s)
          for f in artifacts/build/app/outputs/flutter-apk/*.apk; do
            base="$(basename "$f")"
            cp -v "$f" "dist/${slug}-${ver}-android-${base}"
          done
          
          # Android AAB(s)
          for f in artifacts/build/app/outputs/bundle/release/*.aab; do
            base="$(basename "$f")"
            cp -v "$f" "dist/${slug}-${ver}-android-${base}"
          done
          
          # iOS IPA(s)
          for f in artifacts/build/ios/ipa/*.ipa; do
            base="$(basename "$f")"
            cp -v "$f" "dist/${slug}-${ver}-ios-${base}"
          done
          
          # Windows ZIP
          for f in artifacts/build/windows/*.zip; do
            base="$(basename "$f")"
            cp -v "$f" "dist/${slug}-${ver}-windows-${base}"
          done
          
          # Linux ZIP
          for f in artifacts/build/linux/*.zip; do
            base="$(basename "$f")"
            cp -v "$f" "dist/${slug}-${ver}-linux-${base}"
          done
          
          # macOS ZIP
          for f in artifacts/build/macos/*.zip; do
            base="$(basename "$f")"
            cp -v "$f" "dist/${slug}-${ver}-macos-${base}"
          done

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@v2
        with:
          config: cliff.toml
          args: --latest --strip header
        env:
          OUTPUT: CHANGELOG.md
        continue-on-error: true

      - name: Format commit date (UTC)
        id: format_date
        shell: bash
        run: echo "formatted_date=$(date -u +'%Y-%m-%d %H:%M UTC')" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "ðŸš€ ${{ env.APP_NAME }} v. ${{ env.APP_VERSION }}"
          body: |
            ## ðŸš€ Release ${{ env.APP_NAME }} ${{ env.APP_VERSION }}
            **ðŸ”– Version:** `${{ env.APP_VERSION }}`
            **ðŸ”— Commit:** `${{ github.sha }}`
            **Workflow Run:** [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **ðŸ“… Date:** ${{ steps.format_date.outputs.formatted_date }}

            ### ðŸ“‹ Changelog
            ${{ steps.changelog.outputs.content }}

            ### ðŸ“¦ Included Artifacts
            Android (APK/AAB), iOS (IPA), Windows (ZIP), macOS (ZIP), Linux (ZIP).

            ---
            _Generated automatically by CI/CD pipeline._
          files: ./dist/**
          generate_release_notes: true