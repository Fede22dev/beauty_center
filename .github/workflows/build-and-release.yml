name: Build and Release

on:
  push:
    tags:
      - 'v*'  # e.g., v1.2.3
  workflow_dispatch: { }

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  APP_NAME: Beauty Center

jobs:
  verify:
    name: Verify (lint, test, scan)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 20
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print runner info (debug)
        run: |
          echo "OS: $(uname -a)"
          echo "Repo: $GITHUB_REPOSITORY"
          echo "Ref: $GITHUB_REF"
          echo "Actor: $GITHUB_ACTOR"
          echo "Workspace: $GITHUB_WORKSPACE"
          ls -la

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.2'
          cache: true

      - name: Cache Pub
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart-tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Flutter doctor
        run: |
          flutter --version
          flutter doctor -v

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Check formatting
        run: dart format --output=none --set-exit-if-changed .
        continue-on-error: true

      - name: Analyze code
        run: flutter analyze
        continue-on-error: true

      - name: Run tests
        run: flutter test --coverage
        continue-on-error: true

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Scan dependencies (OSV-Scanner)
        run: |
          go install github.com/google/osv-scanner/v2/cmd/osv-scanner@latest
          "$HOME/go/bin/osv-scanner" scan --lockfile=pubspec.lock
        continue-on-error: true

  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: verify
    permissions:
      contents: read
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.2'
          cache: true

      - name: Cache Pub
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart-tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Flutter doctor
        run: |
          flutter --version
          flutter doctor -v

      # Android build prerequisites and Java on non-macOS
      - name: Set up Java 17
        if: runner.os != 'macOS'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Accept Android licenses (Ubuntu only)
        if: runner.os == 'Linux'
        shell: bash
        run: yes | sdkmanager --licenses || true

      # Linux desktop deps
      - name: Install Linux desktop deps
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev mesa-utils

      # Build Android (Ubuntu only to avoid duplication)
      - name: Build Android APK
        if: runner.os == 'Linux'
        run: flutter build apk --release

      - name: Build Android App Bundle
        if: runner.os == 'Linux'
        run: flutter build appbundle --release

      # Build Windows
      - name: Build Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          flutter build windows --release
          New-Item -ItemType Directory -Force -Path "build/windows" | Out-Null
          $src = "build/windows/x64/runner/Release/*"
          $dst = "build/windows/${env:APP_NAME}.zip"
          Compress-Archive -Path $src -DestinationPath $dst

      # Build Linux
      - name: Build Linux
        if: runner.os == 'Linux'
        shell: bash
        run: |
          flutter build linux --release
          mkdir -p "build/linux"
          zip -r "build/linux/$APP_NAME.zip" build/linux/x64/release/bundle/*

      # Build iOS (no codesign) + macOS (only on macOS)
      - name: Build iOS (no codesign)
        if: runner.os == 'macOS'
        run: flutter build ipa --release --no-codesign

      - name: Build macOS
        if: runner.os == 'macOS'
        shell: bash
        run: |
          flutter build macos --release
          mkdir -p "build/macos"
          app_path="$(ls -d build/macos/Build/Products/Release/*.app | head -n 1)"
          zip -r "build/macos/$APP_NAME.zip" "$app_path"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-artifacts
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/release/*.aab
            build/ios/ipa/*.ipa
            build/macos/*.zip
            build/windows/*.zip
            build/linux/*.zip
          compression-level: 9
          if-no-files-found: warn
          retention-days: 14

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve APP_NAME
        id: app_name
        run: |
          # Prefer pubspec.yaml app_name, else fallback to repo name, else env
          NAME_FROM_PUBSPEC=""
          if [ -f pubspec.yaml ]; then
            NAME_FROM_PUBSPEC="$(grep -E '^[[:space:]]app_name:[[:space:]]*' pubspec.yaml | head -n1 | awk '{print \$2}' | tr -d '"' || true)"
          fi
          if [ -n "${NAME_FROM_PUBSPEC}" ]; then
            APP_NAME_RESOLVED="${NAME_FROM_PUBSPEC}"
          elif [ -n "${APP_NAME:-}" ]; then
            APP_NAME_RESOLVED="${APP_NAME}"
          else
            APP_NAME_RESOLVED="${GITHUB_REPOSITORY##*/}"
          fi
          echo "APP_NAME=${APP_NAME_RESOLVED}" | tee -a "$GITHUB_ENV"
          echo "resolved=${APP_NAME_RESOLVED}" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts (merge into ./artifacts)
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Show downloaded files (debug)
        run: |
          echo "Artifacts directory content:"
          ls -la ./artifacts || true
          echo "--- Find (depth 5) ---"
          find ./artifacts -maxdepth 5 -type f -print | sort || true
          echo "--- Disk usage ---"
          du -sh ./artifacts || true

      - name: Extract version from tag
        run: echo "APP_VERSION=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"

      - name: Install git-cliff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p .bin
          cd .bin
          # Try a few prebuilt tarballs
          for PAT in \
            "git-cliff-*-x86_64-unknown-linux-gnu.tar.gz" \
            "git-cliff-*-x86_64-unknown-linux-musl.tar.gz" \
            "git-cliff-*-aarch64-unknown-linux-gnu.tar.gz" \
            "git-cliff-*-aarch64-unknown-linux-musl.tar.gz"
          do
            if gh release download --repo orhun/git-cliff --pattern "$PAT" ; then
              TAR="$(ls git-cliff-*.tar.gz | head -n1)"
              file -b "$TAR" || true
              tar -xzf "$TAR"
              BIN="$(find . -type f -name git-cliff -perm -u+x | head -n1 || true)"
              if [ -n "${BIN}" ]; then
                install -m 0755 "$BIN" ./git-cliff
                echo "$PWD" >> "$GITHUB_PATH"
                break
              fi
            fi
          done
          cd ..
          echo "git-cliff version:"
          git-cliff --version || (echo "git-cliff not found"; exit 1)

      - name: Generate changelog (robust)
        id: changelog
        run: |
          set -euo pipefail
          rm -f CHANGELOG.md
          echo "Using tag: ${{ steps.app_version.outputs.raw }} (clean: ${{ steps.app_version.outputs.clean }})"
          echo "APP_NAME: ${{ steps.app_name.outputs.resolved }}"
          # Try with cliff.toml if present; fallback to default; then fallback to git log.
          if [ -f cliff.toml ]; then
            if git-cliff -c cliff.toml --latest --strip header > CHANGELOG.md ; then
              echo "git-cliff succeeded with cliff.toml"
            else
              echo "git-cliff failed with cliff.toml; retry without config"
              if git-cliff --latest --strip header > CHANGELOG.md ; then
                echo "git-cliff succeeded without config"
              else
                echo "git-cliff failed; fallback to simple git log"
                git --no-pager log -n 100 --pretty=format:"- %s (%h)" > CHANGELOG.md || true
              fi
            fi
          else
            if git-cliff --latest --strip header > CHANGELOG.md ; then
              echo "git-cliff succeeded without config"
            else
              echo "git-cliff failed; fallback to simple git log"
              git --no-pager log -n 100 --pretty=format:"- %s (%h)" > CHANGELOG.md || true
            fi
          fi
          echo "CHANGELOG preview (first 60 lines):"
          head -n 60 CHANGELOG.md || true
          {
            echo 'content<<EOF'
            cat CHANGELOG.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Format commit date (UTC)
        id: format_date
        shell: bash
        run: echo "formatted_date=$(date -u +'%Y-%m-%d %H:%M UTC')" >> "$GITHUB_OUTPUT"

      - name: Prepare distribution folder and rename assets
        run: |
          set -euo pipefail
          APP_NAME="${{ steps.app_name.outputs.resolved }}"
          VER="${{ steps.app_version.outputs.clean }}"
          
          # Slugify app name for filenames
          SLUG="$(echo "$APP_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-')"
          mkdir -p dist
          shopt -s nullglob
          echo "Renaming assets with slug='${SLUG}' and version='${VER}'"
          echo "Artifacts tree:"
          find artifacts -type f | sort || true
          
          # Android APK(s)
          for f in artifacts/**/app/outputs/flutter-apk/*.apk; do
            base="$(basename "$f")"
            cp -v "$f" "dist/${SLUG}-v${VER}-android-${base}"
          done
          
          # Android AAB(s)
          for f in artifacts/**/app/outputs/bundle/release/*.aab; do
            base="$(basename "$f")"
            cp -v "$f" "dist/${SLUG}-v${VER}-android-${base}"
          done
          
          # iOS IPA(s)
          for f in artifacts/**/ios/ipa/*.ipa; do
            base="$(basename "$f")"
            cp -v "$f" "dist/${SLUG}-v${VER}-ios-${base}"
          done
          
          # Windows ZIP(s)
          for f in artifacts/**/windows/*.zip; do
            base="$(basename "$f")"
            cp -v "$f" "dist/${SLUG}-v${VER}-windows-${base}"
          done
          
          # Linux ZIP(s)
          for f in artifacts/**/linux/*.zip; do
            base="$(basename "$f")"
            cp -v "$f" "dist/${SLUG}-v${VER}-linux-${base}"
          done
          
          # macOS ZIP(s)
          for f in artifacts/**/macos/*.zip; do
            base="$(basename "$f")"
            cp -v "$f" "dist/${SLUG}-v${VER}-macos-${base}"
          done
          
          echo "Final dist content:"
          ls -la dist || true
          echo "---"
          find dist -maxdepth 1 -type f -print | sort || true
          # Optional: uncomment to fail if no files prepared
          # test -n "$(ls -A dist 2>/dev/null)" || { echo "No assets found in dist"; exit 1; }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "${{ env.APP_NAME }} ${{ env.APP_VERSION }}"
          body: |
            ## ðŸš€ Release ${{ env.APP_NAME }} ${{ env.APP_VERSION }}
            **ðŸ”– Version:** `${{ env.APP_VERSION }}`
            **ðŸ”— Commit:** `${{ github.sha }}`
            **ðŸ“… Date:** ${{ steps.format_date.outputs.formatted_date }}
            
            **Workflow Run:** [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### ðŸ“‹ Changelog
            ${{ steps.changelog.outputs.content }}
            
            ### ðŸ“¦ Included Artifacts
            Android (APK/AAB), iOS (IPA), Windows (ZIP), macOS (ZIP), Linux (ZIP).
            
            ---
            _Generated automatically by CI/CD pipeline._
          files: ./dist/**
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: Summary (debug)
        run: |
          echo "Release created for tag: ${{ github.ref_name }}"
          echo "Name: ${{ steps.app_name.outputs.resolved }} v${{ steps.app_version.outputs.clean }}"
          echo "Assets uploaded:"
          ls -la dist || true
