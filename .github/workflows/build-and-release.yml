name: Build and Release

on:
  push:
    tags:
      - 'v*'  # e.g., v1.2.3
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'beta'
        type: choice
        options:
          - production
          - beta

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  FLUTTER_VERSION: '3.35.3'
  JAVA_VERSION: '17'

jobs:
  # Setup Job to extract common information
  setup:
    name: Setup Release Info
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      app_name: ${{ steps.app_info.outputs.app_name }}
      app_version: ${{ steps.app_info.outputs.app_version }}
      build_number: ${{ steps.app_info.outputs.build_number }}
      release_name: ${{ steps.app_info.outputs.release_name }}
      is_prerelease: ${{ steps.app_info.outputs.is_prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract app info
        id: app_info
        run: |
          # Extract info from pubspec.yaml
          APP_NAME=$(grep '^name:' pubspec.yaml | sed 's/name: *//' | tr -d '"' | head -1)
          if [ -z "$APP_NAME" ]; then
            APP_NAME=${GITHUB_REPOSITORY##*/}
          fi
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
            APP_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: *//' | cut -d'+' -f1 | tr -d '"' | head -1)
            BUILD_NUMBER=$(grep '^version:' pubspec.yaml | sed 's/version: *//' | cut -d'+' -f2 | tr -d '"' | head -1)
            if [ -z "$BUILD_NUMBER" ]; then
              BUILD_NUMBER=$(git rev-list --count HEAD)
            fi
            IS_PRERELEASE="true"
            if [ "$RELEASE_TYPE" = "production" ]; then
              IS_PRERELEASE="false"
            fi
            RELEASE_NAME="$APP_NAME v$APP_VERSION ($RELEASE_TYPE)"
          else
            RELEASE_TYPE="production"
            APP_VERSION=${GITHUB_REF#refs/tags/v}
            BUILD_NUMBER=$(git rev-list --count HEAD)
            IS_PRERELEASE="false"
            RELEASE_NAME="$APP_NAME v$APP_VERSION"
          fi
          
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          
          # Debug output
          echo "ðŸš€ Release Info:"
          echo "  App Name: $APP_NAME"
          echo "  Version: $APP_VERSION"
          echo "  Build Number: $BUILD_NUMBER"
          echo "  Release Type: $RELEASE_TYPE"
          echo "  Is Prerelease: $IS_PRERELEASE"

      #  verify:
      #    name: Verify (lint, test, scan)
      #    runs-on: ubuntu-latest
      #    needs: setup
      #    permissions:
      #      contents: read
      #      security-events: write
      #    timeout-minutes: 10
      #    steps:
      #      - name: Harden Runner
      #        uses: step-security/harden-runner@v2
      #        with:
      #          egress-policy: audit
      #
      #      - name: Checkout
      #        uses: actions/checkout@v4
      #        with:
      #          fetch-depth: 0
      #
      #      - name: Set up Flutter
      #        uses: subosito/flutter-action@v2
      #        with:
      #          flutter-version: ${{ env.FLUTTER_VERSION }}
      #          cache: true
      #
      #      - name: Flutter doctor
      #        run: |
      #          flutter --version
      #          flutter doctor -v
      #
      #      - name: Get dependencies
      #        run: flutter pub get
      #
      #      - name: Verify dependencies
      #        run: flutter pub deps
      #
      #      - name: Generate localization files
      #        run: flutter gen-l10n
      #
      #      - name: Analyze code
      #        run: flutter analyze --fatal-infos
      #        continue-on-error: true
      #
      #      - name: Check formatting
      #        run: dart format --set-exit-if-changed .
      #        continue-on-error: true
      #
      #      - name: Run tests
      #        run: flutter test --coverage --reporter=expanded
      #        continue-on-error: true

      # - name: Upload coverage to Codecov
      #   uses: codecov/codecov-action@v3
      #   with:
      #     file: coverage/lcov.info

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    #needs: [ setup, verify ]
    needs: [ setup ]
    permissions:
      contents: read
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Gradle & Android SDK
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
            /usr/local/lib/android/sdk
          key: ${{ runner.os }}-android-sdk-${{ hashFiles('**/build.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-android-sdk-

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Accept Android licenses
        run: yes | flutter doctor --android-licenses || true

      - name: Get dependencies & generate l10n
        run: |
          flutter pub get
          flutter gen-l10n

      - name: Install Fastforge
        run: dart pub global activate fastforge

      - name: Build Android with Fastforge
        run: |
          RELEASE_TYPE="${{ github.event.inputs.release_type || 'production' }}"
          
          echo "=== Fastforge build env vars: ==="
          echo "  RELEASE_TYPE=$RELEASE_TYPE"
          echo "  APP_NAME=$APP_NAME"
          echo "  APP_VERSION=$APP_VERSION"
          
          fastforge release --name $RELEASE_TYPE --jobs android-apk-universal
        env:
          APP_NAME: ${{ needs.setup.outputs.app_name }}
          APP_VERSION: ${{ needs.setup.outputs.app_version }}

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            dist/**/*.apk
          retention-days: 1
          compression-level: 6

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    #needs: [ setup, verify ]
    needs: [ setup ]
    permissions:
      contents: write  # Needed for Fastforge GitHub publisher
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Get dependencies & generate l10n
        run: |
          flutter pub get
          flutter gen-l10n

      - name: Install Fastforge
        run: dart pub global activate fastforge

      - name: Build Windows with Fastforge
        run: |
          $RELEASE_TYPE = "${{ github.event.inputs.release_type || 'production' }}"
          
          Write-Host "=== Fastforge build env vars: ==="
          Write-Host "  RELEASE_TYPE: $RELEASE_TYPE"
          Write-Host "  APP_NAME: $env:APP_NAME"
          Write-Host "  APP_VERSION: $env:APP_VERSION"
          Write-Host "  BUILD_NUMBER: $env:BUILD_NUMBER"
          
          fastforge release --name $RELEASE_TYPE --jobs windows-installer
        env:
          APP_NAME: ${{ needs.setup.outputs.app_name }}
          APP_VERSION: ${{ needs.setup.outputs.app_version }}
          BUILD_NUMBER: ${{ needs.setup.outputs.build_number }}

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            dist/**/*.exe
            dist/**/*.zip
          retention-days: 1
          compression-level: 6

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [ setup, verify, build-android, build-windows ]
    permissions:
      contents: write
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare release assets
        run: |
          mkdir -p dist
          APP_NAME="${{ needs.setup.outputs.app_name }}"
          VERSION="${{ needs.setup.outputs.app_version }}"
          
          # Android APKs
          find artifacts/android-artifacts -name "*.apk" -type f | while read file; do
            cp "$file" "dist/${APP_NAME}-${VERSION}-$(basename $file)"
          done
          
          # Windows installer/ZIP
          find artifacts/windows-artifacts -type f | while read file; do
            ext="${file##*.}"
            cp "$file" "dist/${APP_NAME}-${VERSION}-windows-installer.$ext"
          done
          
          echo "ðŸ“¦ Final release assets:"
          ls -la dist/

      #      - name: Generate release notes
      #        id: release_notes
      #        run: |
      #          VERSION="${{ needs.setup.outputs.app_version }}"
      #
      #          if [ -f "CHANGELOG.md" ]; then
      #            CHANGELOG_SECTION=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | head -n -1 | tail -n +2)
      #            if [ ! -z "$CHANGELOG_SECTION" ]; then
      #              echo "Found changelog section for version $VERSION"
      #              echo "CHANGELOG_CONTENT<<EOF" >> $GITHUB_OUTPUT
      #              echo "$CHANGELOG_SECTION" >> $GITHUB_OUTPUT
      #              echo "EOF" >> $GITHUB_OUTPUT
      #            fi
      #          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ needs.setup.outputs.release_name }}
          body: |
            ## ðŸ“± Platforms & Downloads
            
            | Platform | File | Architecture |
            |----------|------|--------------|
            | ðŸ¤– Android | `*-universal-release.apk` | Universal (all architectures) |
            | ðŸ’» Windows | `*-windows-installer.exe` | Windows Installer (x64) |
            
            ## ðŸ›  Build Info
            - **Version:** `${{ needs.setup.outputs.app_version }}`
            - **Build:** `${{ needs.setup.outputs.build_number }}`
            - **Flutter:** `${{ env.FLUTTER_VERSION }}`
            - **Built:** `${{ github.event.head_commit.timestamp }}`
            
            ## ðŸ“¥ Installation
            **Android:** Download the universal APK.
            
            **Windows:** Download and run the `.exe` installer. Windows may show a security warning - this is normal for unsigned installers.
            
            ---
            _ðŸ¤– Automated release built with GitHub Actions and Fastforge_
          files: ./dist/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ needs.setup.outputs.is_prerelease == 'true' }}
          make_latest: ${{ needs.setup.outputs.is_prerelease == 'false' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#  cleanup:
#    name: Cleanup
#    runs-on: ubuntu-latest
#    needs: [ create-release ]
#    if: always()
#    steps:
#      - name: Delete old releases (keep last 10)
#        uses: dev-drprasad/delete-older-releases@v0.3.2
#        with:
#          keep_latest: 10
#          delete_tag_pattern: v
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}