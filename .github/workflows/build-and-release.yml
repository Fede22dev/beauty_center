name: Build and Release

on:
  workflow_dispatch: { }
  push:
    tags:
      - 'v*'  # e.g., v1.2.3

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  FLUTTER_VERSION: '3.35.2'
  JAVA_VERSION: '17'

jobs:
  verify:
    name: Verify (lint, test, scan)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 20
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Flutter doctor
        run: |
          flutter --version
          flutter doctor -v

      - name: Get dependencies
        run: flutter pub get

      - name: Verify dependencies
        run: flutter pub deps

      - name: Check formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: Analyze code
        run: flutter analyze --fatal-infos

      - name: Run tests
        run: flutter test --coverage --reporter=expanded

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: verify
    permissions:
      contents: read
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release --split-per-abi

      - name: Build App Bundle
        run: flutter build appbundle --release

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/release/*.aab
          retention-days: 14

  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: verify
    permissions:
      contents: read
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign

      - name: Create IPA
        run: |
          mkdir -p build/ios/ipa
          cd build/ios/iphoneos
          zip -r ../ipa/Runner.ipa Runner.app

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifacts
          path: build/ios/ipa/*.ipa
          retention-days: 14

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: verify
    permissions:
      contents: read
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build macOS
        run: flutter build macos --release

      - name: Create macOS ZIP
        run: |
          cd build/macos/Build/Products/Release
          zip -r ../../../../macos-app.zip *.app

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: macos-app.zip
          retention-days: 14

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: verify
    permissions:
      contents: read
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      - name: Create Windows ZIP
        shell: pwsh
        run: |
          $src = "build/windows/x64/runner/Release"
          Compress-Archive -Path "$src/*" -DestinationPath "windows-app.zip"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: windows-app.zip
          retention-days: 14

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: verify
    permissions:
      contents: read
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libblkid-dev

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Linux
        run: flutter build linux --release

      - name: Create Linux ZIP
        run: |
          cd build/linux/x64/release
          zip -r ../../../../linux-app.zip bundle

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: linux-app.zip
          retention-days: 14

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [ build-android, build-ios, build-macos, build-windows, build-linux ]
    permissions:
      contents: write
    timeout-minutes: 15
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get app name from pubspec.yaml
        id: app_name
        run: |
          APP_NAME=$(grep '^name:' pubspec.yaml | cut -d' ' -f2 | tr -d '"' | head -1)
          if [ -z "$APP_NAME" ]; then
            APP_NAME=${GITHUB_REPOSITORY##*/}
          fi
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "name=$APP_NAME" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare release assets
        run: |
          mkdir -p dist
          APP_NAME="${{ steps.app_name.outputs.name }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          # Android
          if [ -d "artifacts/android-artifacts" ]; then
            for file in artifacts/android-artifacts/*.apk; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                cp "$file" "dist/${APP_NAME}-${VERSION}-android-${filename}"
              fi
            done
            for file in artifacts/android-artifacts/*.aab; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                cp "$file" "dist/${APP_NAME}-${VERSION}-android-${filename}"
              fi
            done
          fi
          
          # iOS
          if [ -f "artifacts/ios-artifacts/Runner.ipa" ]; then
            cp "artifacts/ios-artifacts/Runner.ipa" "dist/${APP_NAME}-${VERSION}-ios.ipa"
          fi
          
          # macOS
          if [ -f "artifacts/macos-artifacts/macos-app.zip" ]; then
            cp "artifacts/macos-artifacts/macos-app.zip" "dist/${APP_NAME}-${VERSION}-macos.zip"
          fi
          
          # Windows
          if [ -f "artifacts/windows-artifacts/windows-app.zip" ]; then
            cp "artifacts/windows-artifacts/windows-app.zip" "dist/${APP_NAME}-${VERSION}-windows.zip"
          fi
          
          # Linux
          if [ -f "artifacts/linux-artifacts/linux-app.zip" ]; then
            cp "artifacts/linux-artifacts/linux-app.zip" "dist/${APP_NAME}-${VERSION}-linux.zip"
          fi
          
          echo "Release assets prepared:"
          ls -la dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "${{ env.APP_NAME }} v${{ env.VERSION }}"
          body: |
            ## ðŸš€ Release ${{ env.APP_NAME }} v${{ env.VERSION }}
            
            **ðŸ“± Platforms supported:**
            - Android (APK & AAB)
            - iOS (IPA - requires signing)
            - macOS (ZIP)
            - Windows (ZIP)
            - Linux (ZIP)
            
            **ðŸ“‹ Changes:**
            See [CHANGELOG.md](CHANGELOG.md) for detailed changes.
            
            **ðŸ”— Commit:** `${{ github.sha }}`
            **ðŸ“… Date:** ${{ github.event.head_commit.timestamp }}
            
            ---
            _Generated automatically by GitHub Actions_
          files: ./dist/*
          draft: false
          prerelease: false
