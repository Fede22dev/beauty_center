name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: { }

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.35.3'
  JAVA_VERSION: '17'

jobs:
  # Setup Job to extract common information
  setup:
    name: Setup
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      app_name: ${{ steps.app_info.outputs.app_name }}
      app_version: ${{ steps.app_info.outputs.app_version }}
      release_name: ${{ steps.app_info.outputs.release_name }}
      is_prerelease: ${{ steps.app_info.outputs.is_prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract app info
        id: app_info
        run: |
          APP_NAME=$(grep '^name:' pubspec.yaml | cut -d' ' -f2 | head -1)
          [ -z "$APP_NAME" ] && APP_NAME=${GITHUB_REPOSITORY##*/}
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            APP_VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1 | head -1)
            RELEASE_NAME="$APP_NAME v$APP_VERSION-dev"
            IS_PRERELEASE="true"
          else
            APP_VERSION=${GITHUB_REF#refs/tags/v}
            RELEASE_NAME="$APP_NAME v$APP_VERSION"
            IS_PRERELEASE="false"
          fi
          
          {
            echo "app_name=$APP_NAME"
            echo "app_version=$APP_VERSION"
            echo "release_name=$RELEASE_NAME"
            echo "is_prerelease=$IS_PRERELEASE"
          } >> $GITHUB_OUTPUT
          
          # Debug
          echo "App Release Info:"
          echo "  Name: $APP_NAME"
          echo "  Version: $APP_VERSION"
          echo "  Release Name: $RELEASE_NAME"
          echo "  Is Prerelease: $IS_PRERELEASE"

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: 'pub'

      - name: Accept Android licenses
        run: yes | flutter doctor --android-licenses || true

      - name: Get dependencies & generate l10n & build APK
        run: |
          flutter pub get
          flutter gen-l10n
          flutter build apk --release

      - name: Rename APK and move to dist dir
        run: |
          mkdir -p dist
          cp build/app/outputs/flutter-apk/app-release.apk \
          dist/${{ needs.setup.outputs.app_name }}_v${{ needs.setup.outputs.app_version }}_universal.apk

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: dist/*.apk
          retention-days: 1
          compression-level: 6
          if-no-files-found: error

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: setup
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: 'pub'

      - name: Enable Windows desktop & get dependencies & generate l10n & build
        run: |
          flutter config --enable-windows-desktop
          flutter pub get
          flutter gen-l10n
          flutter build windows --release

      - name: Setup Inno Setup
        run: |
          choco install innosetup -y
          echo "C:\Program Files (x86)\Inno Setup 6" >> $env:GITHUB_PATH

      - name: Create Inno Setup script
        run: |
          $appNameRaw = "${{ needs.setup.outputs.app_name }}"         
          $appNameDisplay = $appNameRaw -replace '_', ' ' 
          $appNameDisplay = (Get-Culture).TextInfo.ToTitleCase($appNameDisplay)
          $appVersion = "${{ needs.setup.outputs.app_version }}"
          
          $ISS_CONTENT = @"
            #define AppNameRaw "$appNameRaw"
            #define AppNameDisplay "$appNameDisplay"
            #define AppVersion "$appVersion"
            #define AppPublisher "Fede22dev"
            #define AppURL "https://github.com/Fede22dev/beauty_center"
            #define AppExeName "$appNameRaw.exe"
            #define AppId "2f38c288-6d20-473b-87cd-5ef9f8bd2f46"
          
            [Setup]
            AppId={#AppId}
            AppName={#AppNameDisplay}
            AppVersion={#AppVersion}
            AppVerName={#AppNameDisplay} {#AppVersion}
            AppPublisher={#AppPublisher}
            AppPublisherURL={#AppURL}
            AppSupportURL={#AppURL}
            AppUpdatesURL={#AppURL}
            DefaultDirName={userpf}\{#AppNameDisplay}
            DefaultGroupName={#AppNameDisplay}
            AllowNoIcons=yes
            OutputDir=dist
            OutputBaseFilename={#AppNameRaw}_v{#AppVersion}_installer
            Compression=lzma2/ultra64
            SolidCompression=yes
            WizardStyle=modern
            DisableWelcomePage=no
            DisableDirPage=no
            DisableProgramGroupPage=yes
            DisableReadyPage=no
            DisableFinishedPage=no
            ArchitecturesAllowed=x64compatible
            ArchitecturesInstallIn64BitMode=x64compatible
            MinVersion=10.0.17763
            PrivilegesRequired=lowest
            UninstallDisplayIcon={app}\{#AppExeName}
            UninstallDisplayName={#AppNameDisplay}
            VersionInfoVersion={#AppVersion}
            VersionInfoCompany={#AppPublisher}
            VersionInfoDescription={#AppNameDisplay}
            CreateUninstallRegKey=yes
            UpdateUninstallLogAppName=yes
            CloseApplications=yes
            RestartApplications=no
          
            [Languages]
            Name: "en"; MessagesFile: "compiler:Default.isl"
            Name: "it"; MessagesFile: "compiler:Languages\Italian.isl"
          
            [Tasks]
            Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}";
          
            [Dirs]
            Name: "{app}"; Flags: uninsalwaysuninstall
          
            [Files]
            Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs uninsrestartdelete
            Source: "{app}\unins*.exe"; DestDir: "{tmp}"; Flags: external skipifsourcedoesntexist deleteafterinstall
          
            [Icons]
            Name: "{group}\{#AppNameDisplay}"; Filename: "{app}\{#AppExeName}"; WorkingDir: "{app}"
            Name: "{group}\{cm:UninstallProgram,{#AppNameDisplay}}"; Filename: "{uninstallexe}"
            Name: "{autodesktop}\{#AppNameDisplay}"; Filename: "{app}\{#AppExeName}"; WorkingDir: "{app}"; Tasks: desktopicon
          
            [Run]
            Filename: "{app}\{#AppExeName}"; Description: "{cm:LaunchProgram,{#AppNameDisplay}}"; Flags: nowait postinstall skipifsilent; WorkingDir: "{app}"
          
            [UninstallRun]
            Filename: "{cmd}"; Parameters: "/C ""taskkill /f /im {#AppExeName} > nul 2>&1"""; RunOnceId: "KillApp"; Flags: runhidden
          
            [UninstallDelete]
            Type: dirifempty; Name: "{app}"
          
            [Code]
            var
              PreviousVersion: String;          
            function GetUninstallString(): String;
              var
                sUnInstPath: String;
                sUnInstallString: String;
              begin
                sUnInstPath := ExpandConstant('Software\Microsoft\Windows\CurrentVersion\Uninstall\{#AppId}_is1');
                sUnInstallString := '';
                if not RegQueryStringValue(HKLM, sUnInstPath, 'UninstallString', sUnInstallString) then
                  RegQueryStringValue(HKCU, sUnInstPath, 'UninstallString', sUnInstallString);
                Result := sUnInstallString;
              end;
          
            function GetPreviousVersion(): String;
              var
                sUnInstPath: String;
                sVersion: String;
              begin
                sUnInstPath := ExpandConstant('Software\Microsoft\Windows\CurrentVersion\Uninstall\{#AppId}_is1');
                sVersion := '';
                if not RegQueryStringValue(HKLM, sUnInstPath, 'DisplayVersion', sVersion) then
                  RegQueryStringValue(HKCU, sUnInstPath, 'DisplayVersion', sVersion);
                Result := sVersion;
              end;
          
            function IsUpgrade(): Boolean;
              begin
                Result := (GetUninstallString() <> '');
              end;
          
            function UnInstallOldVersion(): Integer;
              var
                sUnInstallString: String;
                iResultCode: Integer;
              begin
                Result := 0;
                sUnInstallString := GetUninstallString();
                if sUnInstallString <> '' then begin
                  sUnInstallString := RemoveQuotes(sUnInstallString);
                  if Exec(sUnInstallString, '/SILENT /NORESTART /SUPPRESSMSGBOXES','', SW_HIDE, ewWaitUntilTerminated, iResultCode) then
                    Result := 3
                  else
                    Result := 2;
                end else
                  Result := 1;
              end;
          
            procedure CurStepChanged(CurStep: TSetupStep);
              var
                ResultCode: Integer;
              begin
                if (CurStep = ssInstall) then
                  begin
                    Exec(ExpandConstant('{cmd}'), '/C "taskkill /f /im {#AppExeName} > nul 2>&1"', '', SW_HIDE, ewWaitUntilTerminated, ResultCode);
          
                    if IsUpgrade() then
                      begin
                        PreviousVersion := GetPreviousVersion();
                        UnInstallOldVersion();
                      end;
                  end;
              end;
          
            function InitializeSetup(): Boolean;
              begin
                if IsUpgrade() then
                  begin
                    PreviousVersion := GetPreviousVersion();
                  end;
                  Result := True;
              end;
          
            function NextButtonClick(CurPageID: Integer): Boolean;
              begin
                if (CurPageID = wpWelcome) and IsUpgrade() then
                  begin
                    if MsgBox('A previous version (' + PreviousVersion + ') is already installed. Do you want to upgrade to version {#AppVersion}?',
                      mbConfirmation, MB_YESNO) = IDNO then
                      begin
                        Result := False;
                        Exit;
                      end;
                  end;
                  Result := True;
              end;
          "@
          
          if (!(Test-Path "dist")) { New-Item -ItemType Directory -Path "dist" }
          $ISS_CONTENT | Out-File -FilePath "installer.iss" -Encoding UTF8

      - name: Build installer
        run: |
          mkdir -p dist
          iscc installer.iss

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: dist/*.exe
          retention-days: 1
          compression-level: 6
          if-no-files-found: error

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [ setup, build-android, build-windows ]
    permissions:
      contents: write
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare assets
        run: |
          mkdir -p dist
          find artifacts -type f \( -name "*.apk" -o -name "*.exe" \) -exec cp {} dist/ \;
          
          echo "Final release assets:"
          ls -la dist/

      - name: Generate changelog
        id: changelog
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            LAST_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
            if [[ -n "$LAST_TAG" ]]; then
              CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
            else
              CHANGELOG=$(git log --pretty=format:"- %s" --no-merges -n 10)
            fi
          else
            CHANGELOG="Manual release from workflow dispatch"
          fi
          
          CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
          echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ needs.setup.outputs.release_name }}
          body: |
            ## ðŸ“± Platforms & Downloads
            
            | Platform | File | Architecture |
            |----------|------|--------------|
            | ðŸ¤– Android | `*-universal-release.apk` | Universal (all architectures) |
            | ðŸ’» Windows | `*-windows-installer.exe` | Windows Installer (x64) |
            
            ## ðŸ”„ What's Changed
            ${{ steps.changelog.outputs.changelog }}
            
            ## ðŸ›  Build Info
            - **Version:** `${{ needs.setup.outputs.app_version }}`
            - **Flutter:** `${{ env.FLUTTER_VERSION }}`
            - **Built:** ${{ github.event.head_commit.timestamp }}
            - **Commit:** [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
            
            ## ðŸ“¥ Installation Instructions
            
            ### Android
            1. Download the **universal APK** for maximum compatibility
            2. Enable "Install from Unknown Sources" in Android settings
            3. Install the APK
            
            ### Windows  
            1. Download the **installer.exe**
            2. Run the installer (Windows Defender may show a warning - click "More info" â†’ "Run anyway")
            
            ## ðŸ”’ Security Note
            These builds are unsigned. Windows and Android may show security warnings - this is normal for independent developers.
            
            ---
            _ðŸ¤– Automated release built by GitHub Actions_
          files: dist/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ needs.setup.outputs.is_prerelease == 'true' }}
          make_latest: ${{ needs.setup.outputs.is_prerelease == 'false' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
